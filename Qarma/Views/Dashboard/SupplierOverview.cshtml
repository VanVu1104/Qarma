@model List<Qarma.ViewModels.SupplierStatsViewModel>
@{
    ViewData["Title"] = "Supplier Overview";
}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container-fluid p-4">
    <h2 class="text-primary fw-bold mb-4" style="color: #0d6efd;">Supplier overview</h2>

    <div class="row mb-4">
        <div class="col-md-8">
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0">Select a supplier to see details</span>
                <select class="form-select bg-light border-start-0">
                    <option selected>All Suppliers</option>
                    @foreach (var item in Model)
                    {
                        <option>@item.SupplierName</option>
                    }
                </select>
            </div>
        </div>
        <div class="col-md-4 text-end">
            <button class="btn btn-light border bg-white">01/01/2023 - 26/09/2024</button>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header fw-bold" style="background-color: #dcdcdc;">Supplier - Inspection Pareto</div>
                <div class="card-body">
                    <canvas id="inspectionChart" height="200"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header fw-bold" style="background-color: #dcdcdc;">Supplier - Defect Pareto</div>
                <div class="card-body">
                    <canvas id="defectChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header fw-bold text-white" style="background-color: #3f5d50;">
            Supplier Overview
        </div>
        <div class="card-body p-0">
            <table class="table table-striped table-hover mb-0 align-middle">
                <thead class="text-white" style="background-color: #198754;">
                    <tr>
                        <th class="ps-3">Supplier name</th>
                        <th class="text-center">Minor</th>
                        <th class="text-center">Major</th>
                        <th class="text-center">Critical</th>
                        <th class="text-center">Sum defects</th>
                        <th class="text-center">Defect rate</th>
                        <th class="text-center">Inspections</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td class="fw-bold text-secondary ps-3">
                                <span style="display:inline-block; width:12px; height:12px; border:1px solid #ccc; text-align:center; line-height:10px; margin-right:5px; font-size:10px;">+</span>
                                @item.SupplierName
                            </td>
                            <td class="text-center">@item.Minor</td>
                            <td class="text-center">@item.Major</td>
                            <td class="text-center">@item.Critical</td>
                            <td class="text-center fw-bold">@item.SumDefects</td>
                            <td class="text-center">
                                @item.DefectRate %
                                @if (item.DefectRate > 2.0)
                                {
                                    <span class="badge rounded-circle bg-danger ms-1" style="width:10px; height:10px; padding:0; display:inline-block;">&nbsp;</span>
                                }
                            </td>
                            <td class="text-center">@item.Inspections</td>
                        </tr>
                    }
                </tbody>
                <tfoot class="text-white fw-bold" style="background-color: #198754;">
                    <tr>
                        <td class="ps-3">Total</td>
                        <td class="text-center">@Model.Sum(x => x.Minor)</td>
                        <td class="text-center">@Model.Sum(x => x.Major)</td>
                        <td class="text-center">@Model.Sum(x => x.Critical)</td>
                        <td class="text-center">@Model.Sum(x => x.SumDefects)</td>
                        <td class="text-center">1.39 %</td>
                        <td class="text-center">@Model.Sum(x => x.Inspections)</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<script>
    // --- 1. CHUẨN BỊ DỮ LIỆU ---

    // Lấy dữ liệu từ Server (MVC 5 dùng Json.Encode)
    var supplierNames = @Html.Raw(Json.Encode(Model.Select(x => x.SupplierName)));
    var inspectionsData = @Html.Raw(Json.Encode(Model.Select(x => x.Inspections)));
    var defectsData = @Html.Raw(Json.Encode(Model.Select(x => x.SumDefects)));

    // 2. Dữ liệu Đường (Line) - LẤY TỪ C# (Không hardcode nữa)
    var paretoLineData = @Html.Raw(Json.Encode(Model.Select(x => x.ParetoInspection)));

    // --- XỬ LÝ MÀU SẮC (Cho giống hình) ---
    // 10 cột đầu tiên màu Xanh lá (#198754), các cột còn lại màu Vàng be (#e0dec6)
    var barColors = inspectionsData.map((value, index) => {
        return index < 7 ? '#198754' : '#e0dec6';
    });

    // --- 2. VẼ BIỂU ĐỒ 1: INSPECTION PARETO ---
    const ctxInspection = document.getElementById('inspectionChart').getContext('2d');
    new Chart(ctxInspection, {
        data: {
            labels: supplierNames,
            datasets: [
                {
                    type: 'bar',
                    label: 'Inspections',
                    data: inspectionsData,
                    backgroundColor: barColors, // <--- Đã áp dụng mảng màu Xanh/Vàng
                    order: 2
                },
                {
                    type: 'line',
                    label: 'Pareto %',
                    data: paretoLineData,
                    borderColor: '#6c757d',
                    borderWidth: 2,
                    tension: 0.4,
                    pointRadius: 0, // Ẩn dấu chấm trên đường kẻ cho giống hình
                    yAxisID: 'y1',
                    order: 1
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true, title: { display: true, text: 'Inspections' } },
                y1: {
                    position: 'right',
                    beginAtZero: true,
                    max: 100,
                    grid: { drawOnChartArea: false },
                    title: { display: true, text: 'Pareto %' }
                },
                x: {
                    ticks: {
                        autoSkip: false, // Hiện tất cả tên Supplier không bị ẩn
                        maxRotation: 45, // Xoay chữ nghiêng cho dễ đọc
                        minRotation: 45
                    }
                }
            },
            plugins: {
                legend: { display: false } // Ẩn chú thích (Legend) cho gọn giống hình
            }
        }
    });

    // --- 3. VẼ BIỂU ĐỒ 2: DEFECT PARETO ---
    const ctxDefect = document.getElementById('defectChart').getContext('2d');
    new Chart(ctxDefect, {
        data: {
            labels: supplierNames,
            datasets: [
                {
                    type: 'bar',
                    label: 'Sum Defects',
                    data: defectsData,
                    backgroundColor: '#198754', // Biểu đồ 2 cứ để full xanh hoặc dùng barColors nếu muốn
                    order: 2
                },
                {
                    type: 'line',
                    label: 'Pareto %',
                    data: paretoLineData,
                    borderColor: '#6c757d',
                    borderWidth: 2,
                    tension: 0.4,
                    pointRadius: 0,
                    yAxisID: 'y1',
                    order: 1
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true, title: { display: true, text: 'Sum defects' } },
                y1: {
                    position: 'right',
                    beginAtZero: true,
                    max: 100,
                    grid: { drawOnChartArea: false },
                    title: { display: true, text: 'Pareto %' }
                },
                x: {
                    ticks: {
                        autoSkip: false,
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });
</script>