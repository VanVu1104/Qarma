@model Qarma.ViewModels.DashboardViewModel
@{
    ViewBag.Title = "Inspection Overview";
}

<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Inspection Overview</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/style.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/index.js"></script>

</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4">
        <h2 class="mb-4 text-3xl font-bold text-[#0f4c75]">Inspection overview</h2>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">

            <!-- Left Chart - 8 columns -->
            <div class="lg:col-span-8">
                <div class="bg-white rounded-lg shadow-sm h-full flex flex-col">
                    <div class="bg-gray-600 text-white px-4 py-3 rounded-t-lg">Inspection Distribution</div>
                    <div class="p-0 flex-grow flex flex-col">
                        <div id="chart_inspections" class="flex-grow w-full"></div>
                    </div>
                </div>
            </div>

            <!-- Right Panel - 4 columns -->
            <div class="lg:col-span-4">
                <!-- Date Filter Form -->
                <div class="flex justify-between items-center mb-2">
                    <form method="get" action="@Url.Action("Index", "Dashboard")" id="filterForm" class="flex gap-2 items-center">
                        <input type="text" name="fromDate" value="@Model.FromDate"
                               class="border border-gray-300 rounded px-2 py-1 text-sm text-center font-bold text-gray-700 w-24 focus:outline-none focus:ring-2 focus:ring-green-500"
                               placeholder="dd/mm/yyyy">
                        <span class="font-bold">-</span>
                        <input type="text" name="toDate" value="@Model.ToDate"
                               class="border border-gray-300 rounded px-2 py-1 text-sm text-center font-bold text-gray-700 w-24 focus:outline-none focus:ring-2 focus:ring-green-500"
                               placeholder="dd/mm/yyyy">
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">Lọc</button>
                    </form>
                </div>

                <!-- Timeline Slider (decorative) -->
                <div class="relative mb-4 mt-3 h-5 px-2">
                    <div class="absolute top-1/2 left-0 w-full bg-gray-400 h-0.5 opacity-50"></div>
                    <div class="absolute top-1/2 bg-gray-800 h-0.5 left-[20%] right-[20%]"></div>
                    <div class="absolute top-1/2 bg-white border-2 border-gray-800 rounded-full w-4 h-4 left-[20%] -translate-x-1/2 -translate-y-1/2 cursor-pointer"></div>
                    <div class="absolute top-1/2 bg-white border-2 border-gray-800 rounded-full w-4 h-4 left-[80%] -translate-x-1/2 -translate-y-1/2 cursor-pointer"></div>
                </div>

                <!-- KPI Cards - 4 columns -->
                <div class="grid grid-cols-4 gap-2 mb-4">
                    <div class="bg-white border border-gray-200 rounded shadow-sm p-3 flex flex-col items-center justify-center min-h-[80px]">
                        <div class="font-bold text-gray-800 text-center w-full overflow-hidden"
                             style="font-size: clamp(14px, 2vw, 20px); line-height: 1.2;"
                             title="@Model.Kpis.TotalInspections.ToString("N0")">
                            @Model.Kpis.TotalInspections.ToString("N0")
                        </div>
                        <div class="text-[11px] text-gray-500 mt-1 text-center">Inspections</div>
                    </div>

                    <div class="bg-white border border-gray-200 rounded shadow-sm p-3 flex flex-col items-center justify-center min-h-[80px]">
                        <div class="font-bold text-gray-800 text-center w-full overflow-hidden"
                             style="font-size: clamp(14px, 2vw, 20px); line-height: 1.2;"
                             title="@Model.Kpis.ReInspections.ToString("N0")">
                            @Model.Kpis.ReInspections.ToString("N0")
                        </div>
                        <div class="text-[11px] text-gray-500 mt-1 text-center">Re-Inspections</div>
                    </div>

                    <div class="bg-white border border-gray-200 rounded shadow-sm p-3 flex flex-col items-center justify-center min-h-[80px]">
                        <div class="font-bold text-gray-800 text-center w-full overflow-hidden"
                             style="font-size: clamp(14px, 2vw, 20px); line-height: 1.2;"
                             title="@Model.Kpis.Orders.ToString("N0")">
                            @Model.Kpis.Orders.ToString("N0")
                        </div>
                        <div class="text-[11px] text-gray-500 mt-1 text-center">Orders</div>
                    </div>

                    <div class="bg-white border border-gray-200 rounded shadow-sm p-3 flex flex-col items-center justify-center min-h-[80px]">
                        <div class="font-bold text-gray-800 text-center w-full overflow-hidden"
                             style="font-size: clamp(14px, 2vw, 20px); line-height: 1.2;"
                             title="@Model.Kpis.Items.ToString("N0")">
                            @Model.Kpis.Items.ToString("N0")
                        </div>
                        <div class="text-[11px] text-gray-500 mt-1 text-center">Items</div>
                    </div>
                </div>

                <!-- Defect Chart Card -->
                <div class="bg-white rounded-lg shadow-sm mb-3">
                    <div class="bg-[#cfd8dc] text-black font-bold px-4 py-3 rounded-t-lg">Defect Severity Distribution</div>
                    <div class="p-2">
                        <div id="chart_defects" style="height: 200px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
    var rawDefects = @Html.Raw(Json.Encode(Model.DefectStats));
    var rawConclusions = @Html.Raw(Json.Encode(Model.Conclusions));

    google.charts.load('current', { 'packages': ['corechart', 'bar'] });
    google.charts.setOnLoadCallback(drawSmallCharts);

    function drawSmallCharts() {
        drawDefectChart();
    }

    function drawDefectChart() {
        if (!rawDefects || rawDefects.length === 0) return;
        var dataArray = [['Severity', 'Defects', { role: 'style' }, { role: 'annotation' }]];
        for (var i = 0; i < rawDefects.length; i++) {
            dataArray.push([
                rawDefects[i].Severity,
                rawDefects[i].Count,
                rawDefects[i].Color,
                rawDefects[i].Count.toLocaleString() // Thêm số liệu hiển thị trên cột
            ]);
        }
        var data = google.visualization.arrayToDataTable(dataArray);
        var options = {
            legend: { position: 'none' },
            vAxis: { minValue: 0 },
            annotations: {
                alwaysOutside: true,
                textStyle: {
                    fontSize: 12,
                    bold: true,
                    color: '#000'
                }
            }
        };
        var chart = new google.visualization.ColumnChart(document.getElementById('chart_defects'));
        chart.draw(data, options);
    }
    </script>

    <script>
    var rawInspections = @Html.Raw(Json.Encode(Model.MonthlyInspections));

    document.addEventListener("DOMContentLoaded", function () {

        // ==========================
        //  DỮ LIỆU CHO BIỂU ĐỒ
        // ==========================
        var dataValues = [];
        var dataCategories = [];

        if (rawInspections && rawInspections.length > 0) {
            for (var i = 0; i < rawInspections.length; i++) {
                dataValues.push(rawInspections[i].Count);
                var parts = rawInspections[i].MonthYear.split('-');
                var month = parts[0];
                var year = "20" + parts[1];

                if (month === "Jan") {
                    dataCategories.push([month, year]);
                } else {
                    dataCategories.push(month);
                }
            }
        }

        var options = {
            series: [{ name: 'Inspections', data: dataValues }],
            chart: {
                type: 'bar',
                height: '100%',
                toolbar: { show: false },
                fontFamily: 'Helvetica, Arial, sans-serif',
                parentHeightOffset: 0,
            },
            plotOptions: {
                bar: {
                    borderRadius: 0,
                    columnWidth: '65%',
                    dataLabels: { position: 'top' }
                }
            },
            dataLabels: { enabled: true, offsetY: -20, style: { fontSize: '12px', colors: ["#304758"] } },
            colors: ['#2E8B57'],
            xaxis: {
                categories: dataCategories,
                position: 'bottom',
                axisBorder: { show: false },
                axisTicks: { show: false },
                labels: {
                    style: { fontSize: '12px', colors: '#555' },
                    offsetY: 0
                },
                tooltip: { enabled: false }
            },
            yaxis: {
                axisBorder: { show: false },
                axisTicks: { show: false },
                labels: { show: true, formatter: function (val) { return val.toFixed(0); } }
            },
            grid: {
                strokeDashArray: 4,
                padding: {
                    bottom: 0,
                    left: 10,
                    right: 0
                }
            }
        };

        var chart = new ApexCharts(document.querySelector("#chart_inspections"), options);
        chart.render();

        // ==========================
        //  FLATPICKR – CHỌN THÁNG / NĂM
        // ==========================
        const flatpickrConfig = {
            plugins: [
                new monthSelectPlugin({
                    shorthand: true,
                    dateFormat: "m/Y", // Quan trọng: Format gửi về server (ví dụ: 5/2025)
                    altFormat: "F Y",  // Format hiển thị đẹp cho user (ví dụ: May 2025)
                    theme: "light"
                })
            ],
            dateFormat: "m/Y",
            allowInput: true
        };
       // Áp dụng cho From Date
        flatpickr("input[name='fromDate']", {
            ...flatpickrConfig,
            defaultDate: "@Model.FromDate" // Server trả về "05/2025" sẽ khớp vào đây
        });

        // Áp dụng cho To Date
        flatpickr("input[name='toDate']", {
            ...flatpickrConfig,
            defaultDate: "@Model.ToDate"
        });

    });
    </script>

</body>
</html>