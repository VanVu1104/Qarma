@using Newtonsoft.Json
@using Newtonsoft.Json.Serialization
@model Qarma.Models.SupplierDashboardViewModel

@{
    ViewBag.Title = "Supplier Performance";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<link rel="stylesheet" href="~/Content/Performance/performance_share.css"/>
<style>
    text {
        font-family: 'Inter', sans-serif !important;
    }

    /* Animation Gauge */
    .gauge-fill {
        transition: transform 1s cubic-bezier(0.4, 0, 0.2, 1);
        transform-origin: center;
        clip-path: polygon(0 0, 100% 0, 100% 50%, 0 50%);
    }

    /* Leaflet Popup */
    .leaflet-popup-content-wrapper {
        border-radius: 8px;
        font-family: 'Inter', sans-serif;
        font-size: 12px;
    }

    .leaflet-popup-tip {
        background: white;
    }

    /* Pie Chart Overlay */
    .relative-container {
        position: relative;
    }

    .hidden {
        display: none;
    }
    
</style>

<div class="space-y-6 pb-10 font-sans text-gray-700">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center pb-2">
        <div>
            <h1 class="text-3xl font-extrabold text-[#1a5c85]">Supplier performance</h1>
            <div class="flex items-center mt-3 text-gray-800">
                @Html.DropDownList("SelectedCustomer",
                    (IEnumerable<SelectListItem>)ViewBag.DsKhachHang,
                    "--- Chọn khách hàng ---",
                    new
                    {
                        @id = "customer-select",
                        @class = "form-select block w-auto pl-3 pr-8 py-1.5 text-base font-semibold text-[#1a5c85] bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#1a5c85] focus:border-transparent cursor-pointer transition ease-in-out duration-150"
                    })
            </div>
        </div>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-6 px-4 md:px-12 pt-4">

        <div class="flex flex-col items-center relative">
            <span class="text-[0.85rem] text-gray-600 font-bold mb-[2px] text-center">Rejection rate</span>
            <span id="kpi-rej-target" class="text-xs text-gray-400 font-medium mb-2">-- %</span>
            <div class="w-[160px] h-[80px] overflow-hidden relative group">
                <div class="w-[160px] h-[160px] border-[16px] border-gray-200 rounded-full absolute top-0 left-0 box-border"></div>
                <div id="kpi-rej-fill" class="gauge-fill w-[160px] h-[160px] border-[16px] border-gray-300 rounded-full absolute top-0 left-0 box-border" style="transform: rotate(-180deg);"></div>
            </div>
            <span id="kpi-rej-val" class="absolute bottom-[0px] w-full text-center text-[1.35rem] font-bold text-gray-400">--</span>
        </div>

        <div class="flex flex-col items-center relative">
            <span class="text-[0.85rem] text-gray-600 font-bold mb-[2px] text-center">Re-inspection rate</span>
            <span id="kpi-reins-target" class="text-xs text-gray-400 font-medium mb-2">-- %</span>
            <div class="w-[160px] h-[80px] overflow-hidden relative">
                <div class="w-[160px] h-[160px] border-[16px] border-gray-200 rounded-full absolute top-0 left-0 box-border"></div>
                <div id="kpi-reins-fill" class="gauge-fill w-[160px] h-[160px] border-[16px] border-gray-300 rounded-full absolute top-0 left-0 box-border" style="transform: rotate(-180deg);"></div>
            </div>
            <span id="kpi-reins-val" class="absolute bottom-[0px] w-full text-center text-[1.35rem] font-bold text-gray-400">--</span>
        </div>

        <div class="flex flex-col items-center relative">
            <span class="text-[0.85rem] text-gray-600 font-bold mb-[2px] text-center">Defect rate</span>
            <span id="kpi-def-target" class="text-xs text-gray-400 font-medium mb-2">-- %</span>
            <div class="w-[160px] h-[80px] overflow-hidden relative">
                <div class="w-[160px] h-[160px] border-[16px] border-gray-200 rounded-full absolute top-0 left-0 box-border"></div>
                <div id="kpi-def-fill" class="gauge-fill w-[160px] h-[160px] border-[16px] border-[#dc2626] rounded-full absolute top-0 left-0 box-border" style="transform: rotate(-180deg);"></div>
            </div>
            <span id="kpi-def-val" class="absolute bottom-[0px] w-full text-center text-[1.35rem] font-bold text-[#dc2626]">--</span>
        </div>

        <div class="flex flex-col items-center relative">
            <span class="text-[0.85rem] text-gray-600 font-bold mb-[2px] text-center">Measurement rate</span>
            <span id="kpi-meas-target" class="text-xs text-gray-400 font-medium mb-2">-- %</span>
            <div class="w-[160px] h-[80px] overflow-hidden relative">
                <div class="w-[160px] h-[160px] border-[16px] border-gray-200 rounded-full absolute top-0 left-0 box-border"></div>
                <div id="kpi-meas-fill" class="gauge-fill w-[160px] h-[160px] border-[16px] border-gray-300 rounded-full absolute top-0 left-0 box-border" style="transform: rotate(-180deg);"></div>
            </div>
            <span id="kpi-meas-val" class="absolute bottom-[0px] w-full text-center text-[1.35rem] font-bold text-gray-400">--</span>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 h-auto lg:h-[400px] mt-8">

        <div class="lg:col-span-8 border border-gray-400 bg-white shadow-sm flex flex-col">
            <div class="bg-gray-300 px-3 py-2 font-bold text-[0.85rem] text-gray-800 border-b border-gray-400 flex justify-between">
                <span id="chart-dist-title">Inspection Distribution</span>
            </div>
            <div class="flex-grow p-4 relative">
                <div id="chart_distribution" class="w-full h-full" style="min-height: 280px; display: flex; justify-content: center; align-items: center; height: 100%; color: #9ca3af; font-size: 12px;"></div>
            </div>
        </div>

        <div class="lg:col-span-4 border border-gray-400 bg-white shadow-sm flex flex-col relative overflow-hidden">
            <div class="bg-gray-300 px-3 py-2 font-bold text-[0.85rem] text-gray-800 border-b border-gray-400 flex justify-between items-center z-20 relative">
                <span id="map-title">Inspection Map - Loading...</span>
            </div>
            <div class="flex-grow relative bg-[#c8dce0]">
                <div id="chart_map" class="w-full h-full z-0 " style="min-height: 300px; display: flex; justify-content: center; align-items: center; height: 100%; color: #9ca3af; font-size: 12px;"></div>
                <div class="absolute bottom-0 right-0 px-1 bg-white/70 text-[10px] text-gray-500 z-10 pointer-events-none">
                    <span>© OpenStreetMap</span>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 h-auto lg:h-[320px]">

        <div class="lg:col-span-1 border border-gray-400 bg-white shadow-sm flex flex-col">
            <div class="bg-gray-300 px-3 py-2 font-bold text-[0.85rem] text-gray-800 border-b border-gray-400">
                Defect Severity Distribution
            </div>
            <div class="flex-grow p-1">
                <div id="chart_severity" class="w-full h-full" style="display: flex; justify-content: center; align-items: center; height: 100%; color: #9ca3af; font-size: 12px;"></div>
            </div>
        </div>

        @*Defects Category*@
        <div class="lg:col-span-1 border border-gray-400 bg-white shadow-sm flex flex-col">
            <div class="bg-gray-300 px-3 py-2 font-bold text-[0.85rem] text-gray-800 border-b border-gray-400">
                Defects Category
            </div>
            <div class="flex-grow p-1 relative-container">
                <div id="chart_category" class="w-full h-full" style="display: flex; justify-content: center; align-items: center; height: 100%; color: #9ca3af; font-size: 12px;"></div>
            </div>
        </div>

        @*Defect Type Pareto*@
        <div class="lg:col-span-2 border border-gray-400 bg-white shadow-sm flex flex-col">
            <div class="bg-gray-300 px-3 py-2 font-bold text-[0.85rem] text-gray-800 border-b border-gray-400">
                Defect Type Pareto
            </div>
            <div class="flex-grow p-1 relative">
                <div id="chart_pareto" class="w-full h-full" style="display: flex; justify-content: center; align-items: center; height: 100%; color: #9ca3af; font-size: 12px;"></div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="~/Scripts/Performance/supplier_performance.js"></script>
}