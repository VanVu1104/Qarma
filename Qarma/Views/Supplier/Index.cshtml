@model List<Qarma.ViewModels.SupplierStatsViewModel>
@{ 
    Layout = null;
}


<script src="https://cdn.tailwindcss.com"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<style>
    /* Thanh cuộn nhỏ gọn */
    .custom-scroll::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    .custom-scroll::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    .custom-scroll::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
    }

    .custom-scroll::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }

    /* Font bảng siêu nhỏ gọn */
    .table-compact th, .table-compact td {
        font-size: 13px; /* 0.7rem */
        padding: 10px 12px;
        border-bottom: 1px solid #f3f4f6;
        white-space: nowrap;
    }

    /* Sticky Header cho bảng */
    .sticky-header th {
        position: sticky;
        top: 0;
        z-index: 10;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
</style>
<div class="p-4 text-slate-800 font-sans text-sm bg-gray-50 min-h-screen">

    <div class="mb-4">
        <h1 class="text-3xl font-bold text-[#198754]">Supplier Overview</h1>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 items-end">

        <div class="flex flex-col gap-2">
            <div class="w-1/2">
                <input type="text" placeholder="Select a supplier..."
                       class="w-full bg-gray-200 text-gray-600 rounded-full px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[#198754] shadow-inner cursor-pointer"
                       readonly>
            </div>

            <div class="bg-white p-2 rounded shadow border-t-4 border-[#198754]">
                <h3 class="font-bold text-xs bg-gray-200 p-1 mb-1 text-gray-700">Supplier - Inspections (Pareto)</h3>
                <div class="overflow-x-auto custom-scroll">
                    <div id="inspection_chart" style="height: 250px;"></div>
                </div>
            </div>
        </div>

        <div class="flex flex-col gap-2">
            <div class="flex flex-col items-start justify-end w-full pb-1">
                <div class="bg-white border border-gray-300 rounded-md px-4 py-2 text-sm font-medium text-gray-700 shadow-sm flex items-center gap-2 cursor-pointer hover:bg-gray-50 transition-colors">
                    <span>01/01/2023</span><span>-</span><span>Current</span>
                </div>
            </div>

            <div class="bg-white p-2 rounded shadow border-t-4 border-[#198754]">
                <h3 class="font-bold text-xs bg-gray-200 p-1 mb-1 text-gray-700">Supplier - Defects (Pareto)</h3>
                <div class="overflow-x-auto custom-scroll">
                    <div id="defect_chart" style="height: 250px;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-white rounded shadow border border-gray-200">
        <div class="bg-gray-400 text-white px-3 py-1 font-bold text-sm">
            Supplier Statistics Detail
        </div>

        <div class="overflow-y-auto max-h-[400px] custom-scroll">
            <table class="w-full text-left table-compact relative">
                <thead class="bg-[#198754] text-white uppercase font-semibold sticky top-0 z-20 shadow-sm">
                    <tr>
                        <th class="bg-[#198754] w-48">Supplier Name</th>
                        <th class="text-center bg-[#198754]">Minor</th>
                        <th class="text-center bg-[#198754]">Major</th>
                        <th class="text-center bg-[#198754]">Critical</th>
                        <th class="text-center bg-[#198754]">Total<br>Defects</th>
                        <th class="text-center bg-[#198754]">Defect<br>Rate</th>
                        <th class="text-right bg-[#198754]">Sample<br>Qty</th>
                        <th class="text-right bg-[#198754]">Avail<br>Qty</th>
                        <th class="text-center bg-[#198754]">Inspec.</th>
                        <th class="text-center bg-[#198754]">Reject<br>Rate</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 bg-gray-50 text-gray-700">
                    @foreach (var item in Model)
                    {
                        <tr class="hover:bg-gray-100 transition-colors">
                            <td class="align-top font-bold text-[#198754]">
                                @item.SupplierName
                            </td>
                            <td class="text-center">@item.Minor</td>
                            <td class="text-center">@item.Major</td>
                            <td class="text-center">@item.Critical</td>
                            <td class="text-center font-bold text-gray-900">@item.SumDefects</td>

                            <td class="text-center">
                                <div class="flex items-center justify-center space-x-1">
                                    @if (item.DefectRate > 5.0) // Ví dụ logic cảnh báo đỏ
                                    {<span class="h-2 w-2 rounded-full bg-red-500 animate-pulse"></span>}
                                    <span>@item.DefectRate%</span>
                                </div>
                            </td>

                            <td class="text-right">@item.SampleQuantity.ToString("N0")</td>
                            <td class="text-right">@item.AvailableQuantity.ToString("N0")</td>
                            <td class="text-center font-semibold">@item.Inspections</td>

                            <td class="text-center">
                                <div class="flex items-center justify-center space-x-1">
                                    @if (item.RejectionRate > 0)
                                    {<span class="h-2 w-2 rounded-full bg-red-500"></span>}
                                    <span>@item.RejectionRate%</span>
                                </div>
                            </td>
                        </tr>
                    }

                    @if (Model.Any())
                    {
                        <tr class="bg-[#198754] text-white font-bold sticky bottom-0 z-20 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
                            <td class="bg-[#198754]">TOTAL</td>
                            <td class="text-center bg-[#198754]">@Model.Sum(x => x.Minor)</td>
                            <td class="text-center bg-[#198754]">@Model.Sum(x => x.Major)</td>
                            <td class="text-center bg-[#198754]">@Model.Sum(x => x.Critical)</td>
                            <td class="text-center bg-[#198754]">@Model.Sum(x => x.SumDefects)</td>

                            <td class="text-center bg-[#198754]">-</td>

                            <td class="text-right bg-[#198754]">@Model.Sum(x => x.SampleQuantity).ToString("N0")</td>
                            <td class="text-right bg-[#198754]">@Model.Sum(x => x.AvailableQuantity).ToString("N0")</td>
                            <td class="text-center bg-[#198754]">@Model.Sum(x => x.Inspections)</td>
                            <td class="text-center bg-[#198754]">-</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<script type="text/javascript">
    google.charts.load('current', { packages: ['corechart'] });
    google.charts.setOnLoadCallback(drawCharts);

    function drawCharts() {
        var rawData = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model));

        // 1. Vẽ Pareto Chart cho Inspections
        drawParetoChart(
            rawData,
            'inspection_chart',
            'SupplierName',
            'Inspections',
            'Inspections'
        );

        // 2. Vẽ Pareto Chart cho Defects (Dùng SumDefects)
        drawParetoChart(
            rawData,
            'defect_chart',
            'SupplierName',
            'SumDefects',
            'Total Defects'
        );
    }

    // --- HÀM VẼ PARETO (Đã custom để hợp với giao diện này) ---
    function drawParetoChart(data, elementId, nameKey, valueKey, yLabel) {
        if (!data || data.length === 0) {
            document.getElementById(elementId).innerHTML = '<div class="flex items-center justify-center h-full text-gray-400">No Data</div>';
            return;
        }

        // B1: Sắp xếp & Lọc
        let sortedData = [...data].sort((a, b) => b[valueKey] - a[valueKey]);
        // Lọc bỏ những ông = 0 để biểu đồ đỡ dài
        sortedData = sortedData.filter(x => x[valueKey] > 0);

        if (sortedData.length === 0) return;

        // B2: Tính chiều rộng động (Logic từ code tham khảo của bạn)
        // Mỗi cột khoảng 45px, nếu ít quá thì để 100%
        var minChartWidth = sortedData.length > 8 ? (sortedData.length * 45) + 'px' : '100%';
        document.getElementById(elementId).style.width = minChartWidth;

        // B3: Tính toán Cumulative %
        let totalValue = sortedData.reduce((sum, item) => sum + item[valueKey], 0);
        let runningTotal = 0;

        var dataTable = new google.visualization.DataTable();
        dataTable.addColumn('string', 'Supplier');
        dataTable.addColumn('number', yLabel);
        dataTable.addColumn({ type: 'string', role: 'style' }); // Màu cột
        dataTable.addColumn({ type: 'number', role: 'annotation' }); // Số trên đầu cột
        dataTable.addColumn('number', 'Pareto %'); // Đường line
        dataTable.addColumn({ type: 'string', role: 'tooltip' });

        // Màu sắc: Lấy theo tông xanh #198754 của giao diện tham khảo
        const colorMain = '#198754';  // Xanh lá đậm (giống header)
        const colorFade = '#e2e8f0';  // Xám/Be nhạt (cho phần đuôi) - dùng slate-200 cho hợp tông
        const colorLine = '#064e3b';  // Xanh rất đậm cho đường Line

        sortedData.forEach(item => {
            let val = item[valueKey];
            runningTotal += val;
            let cumulativePercent = totalValue === 0 ? 0 : (runningTotal / totalValue);

            // Logic màu: Top 80% màu Xanh, còn lại màu Nhạt
            let barColor = (cumulativePercent <= 0.85) ? colorMain : colorFade;
            // Nếu giá trị quá bé so với max (< 15%), cho màu nhạt luôn cho đẹp
            if (val < sortedData[0][valueKey] * 0.15) barColor = colorFade;

            let tooltip = `${item[nameKey]}\n${yLabel}: ${val}\nPareto: ${(cumulativePercent * 100).toFixed(1)}%`;

            dataTable.addRow([
                item[nameKey],
                val,
                `color: ${barColor}; stroke-width: 0`,
                val,
                cumulativePercent,
                tooltip
            ]);
        });

        // B4: Options (Tinh chỉnh cho gọn gàng trong khung nhỏ)
        var options = {
            fontName: 'Arial', // Font mặc định hệ thống
            fontSize: 10,      // Font bé để vừa khung
            backgroundColor: 'transparent',
            chartArea: { left: 40, top: 20, right: 40, bottom: 60, width: '100%', height: '70%' },

            seriesType: 'bars',
            series: {
                1: {
                    type: 'line',
                    targetAxisIndex: 1,
                    color: colorLine,
                    lineWidth: 2,
                    pointSize: 3
                }
            },

            vAxes: {
                0: {
                    gridlines: { count: 4, color: '#f1f5f9' },
                    textStyle: { color: '#64748b' },
                    minValue: 0
                },
                1: {
                    format: '#%',
                    gridlines: { color: 'transparent' },
                    textStyle: { color: '#64748b' },
                    minValue: 0, maxValue: 1.1
                }
            },

            hAxis: {
                slantedText: true,
                slantedTextAngle: 45,
                textStyle: { fontSize: 9, color: '#334155' }
            },

            bar: { groupWidth: '80%' },
            legend: { position: 'none' },
            annotations: {
                alwaysOutside: true,
                textStyle: { fontSize: 9, bold: true, color: '#333' }
            }
        };

        var chart = new google.visualization.ComboChart(document.getElementById(elementId));
        chart.draw(dataTable, options);
    }
</script>