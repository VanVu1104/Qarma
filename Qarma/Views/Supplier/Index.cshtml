@model List<Qarma.ViewModels.SupplierStatsViewModel>
@{ 
    Layout = null;
}

<script src="https://cdn.tailwindcss.com"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<style>
    /* Thanh cuộn nhỏ gọn */
    .custom-scroll::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    .custom-scroll::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    .custom-scroll::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
    }

    .custom-scroll::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }

    /* Font bảng siêu nhỏ gọn */
    .table-compact th, .table-compact td {
        font-size: 13px; /* 0.7rem */
        padding: 10px 12px;
        border-bottom: 1px solid #f3f4f6;
        white-space: nowrap;
    }

    /* Sticky Header cho bảng */
    .sticky-header th {
        position: sticky;
        top: 0;
        z-index: 10;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
</style>
<div class="p-4 text-slate-800 font-sans text-sm bg-gray-50 min-h-screen">

    <div class="mb-4">
        <h1 class="text-3xl font-bold text-[#198754]">Supplier Overview</h1>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 items-end">

        <div class="flex flex-col gap-2">
            <div class="w-1/2">
                <input type="text" placeholder="Select a supplier..."
                       class="w-full bg-gray-200 text-gray-600 rounded-full px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[#198754] shadow-inner cursor-pointer"
                       readonly>
            </div>

            <div class="bg-white p-2 rounded shadow border-t-4 border-[#198754]">
                <h3 class="font-bold text-xs bg-gray-200 p-1 mb-1 text-gray-700">Supplier - Inspections (Pareto)</h3>
                <div class="overflow-x-auto custom-scroll">
                    <div id="inspection_chart" style="height: 250px;"></div>
                </div>
            </div>
        </div>

        <div class="flex flex-col gap-2">
            <form method="get" action="@Url.Action("Index")" class="flex items-center gap-2 bg-white border border-gray-300 rounded-md px-2 py-1 shadow-sm">

                <input type="date" name="start"
                       value="@ViewBag.StartDate"
                       class="text-sm text-gray-700 border-none focus:ring-0 outline-none cursor-pointer bg-transparent"
                       required />

                <span class="text-gray-400 font-bold">-</span>

                <input type="date" name="end"
                       value="@ViewBag.EndDate"
                       class="text-sm text-gray-700 border-none focus:ring-0 outline-none cursor-pointer bg-transparent"
                       required />

                <button type="submit" class="ml-2 bg-[#198754] text-white text-xs font-bold px-3 py-1.5 rounded hover:bg-[#14532d] transition-colors shadow-sm flex items-center gap-1">
                    <i data-lucide="filter" width="10" height="10" class="me-1"></i>
                </button>
            </form>

            <div class="bg-white p-2 rounded shadow border-t-4 border-[#198754]">
                <h3 class="font-bold text-xs bg-gray-200 p-1 mb-1 text-gray-700">Supplier - Defects (Pareto)</h3>
                <div class="overflow-x-auto custom-scroll">
                    <div id="defect_chart" style="height: 250px;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-white rounded shadow border border-gray-200">
        <div class="bg-gray-400 text-white px-3 py-1 font-bold text-sm">
            Supplier Statistics Detail
        </div>

        <div class="overflow-y-auto max-h-[400px] custom-scroll">
            <table class="w-full text-left table-compact relative">
                <thead class="bg-[#198754] text-white uppercase font-semibold sticky top-0 z-20 shadow-sm">
                    <tr>
                        <th class="w-1/4 pl-4 bg-[#198754] w-48">Supplier Name</th>
                        <th class="text-center w-24 bg-[#198754]">Minor</th>
                        <th class="text-center w-24 bg-[#198754]">Major</th>
                        <th class="text-center w-24 bg-[#198754]">Critical</th>
                        <th class="text-center w-24 bg-[#198754]">Total<br>Defects</th>
                        <th class="text-center w-24 bg-[#198754]">Defect<br>Rate (%)</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 bg-gray-50 text-gray-700">
                    @foreach (var item in Model)
                    {
                        <tr class="hover:bg-gray-100 transition-colors">
                            <td class="align-top font-bold text-[#198754]">
                                @item.SupplierName
                            </td>
                            <td class="text-center">@item.Minor</td>
                            <td class="text-center">@item.Major</td>
                            <td class="text-center">@item.Critical</td>
                            <td class="text-center font-bold text-gray-900">@item.SumDefects</td>

                            <td class="text-center">
                                <div class="flex items-center justify-center space-x-1">
                                    @if (item.DefectRate > 5.0) // Ví dụ logic cảnh báo đỏ
                                    {<span class="h-2 w-2 rounded-full bg-red-500 animate-pulse"></span>}
                                    <span>@item.DefectRate.ToString("0.00")</span>
                                </div>
                            </td>
                        </tr>
                    }

                    @if (Model.Any())
                    {
                        <tr class="bg-[#198754] text-white font-bold sticky bottom-0 z-20 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
                            <td class="bg-[#198754]">TOTAL</td>
                            <td class="text-center bg-[#198754]">@Model.Sum(x => x.Minor)</td>
                            <td class="text-center bg-[#198754]">@Model.Sum(x => x.Major)</td>
                            <td class="text-center bg-[#198754]">@Model.Sum(x => x.Critical)</td>
                            <td class="text-center bg-[#198754]">@Model.Sum(x => x.SumDefects)</td>
                            <td class="text-center bg-[#198754]"></td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<script type="text/javascript">
    google.charts.load('current', { packages: ['corechart'] });
    google.charts.setOnLoadCallback(drawCharts);

    function drawCharts() {
        // Lấy dữ liệu từ C#
        var rawData = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model));

        // 1. Vẽ biểu đồ Trái: CHỈ CÓ CỘT XANH (TotalPassed)
        drawInspectionChart(rawData);

        // 2. Vẽ biểu đồ Phải: PARETO LỖI (Cột + Line)
        drawDefectPareto(rawData);
    }

    // --- HÀM 1: VẼ BIỂU ĐỒ INSPECTION (CHỈ CỘT MÀU XANH) ---
    function drawInspectionChart(data) {
        var elementId = 'inspection_chart';
        if (!data || data.length === 0) {
            document.getElementById(elementId).innerHTML = '<div class="flex items-center justify-center h-full text-gray-400">No Data</div>';
            return;
        }

        // [QUAN TRỌNG]: Đã sửa TotalPassed -> SumPassed để khớp với SQL
        let chartData = data.map(item => {
            // Ưu tiên lấy SumPassed (theo C# mới), dự phòng sumPassed (viết thường)
            let val = item.SumPassed !== undefined ? item.SumPassed : (item.sumPassed || 0);

            return {
                Name: item.SupplierName || item.supplierName || "Unknown",
                Value: parseFloat(val) // Ép kiểu về số
            };
        });

        // Sắp xếp giảm dần theo số lượng Đạt
        chartData.sort((a, b) => b.Value - a.Value);

        // Lọc lấy dòng có dữ liệu Đạt > 0
        let sortedData = chartData.filter(x => x.Value > 0);

        // Kiểm tra lại sau khi lọc
        if (sortedData.length === 0) {
            document.getElementById(elementId).innerHTML = '<div class="flex items-center justify-center h-full text-gray-400">Data is 0</div>';
            return;
        }

        document.getElementById(elementId).style.width = '100%';

        // Tạo Bảng Dữ Liệu
        var dataTable = new google.visualization.DataTable();
        dataTable.addColumn('string', 'Supplier');
        dataTable.addColumn('number', 'Passed');
        dataTable.addColumn({ type: 'string', role: 'tooltip', p: { html: true } });
        dataTable.addColumn({ type: 'string', role: 'style' }); // Cột màu

        sortedData.forEach(item => {
            var tooltipHtml = `
            <div class="p-2 text-xs font-sans" style="min-width: 120px">
                <strong class="text-sm block mb-1 border-b pb-1 text-gray-700">${item.Name}</strong>
                <div class="flex justify-between items-center gap-3 mt-1">
                    <span><span style="color:#198754; font-size:14px">●</span> Passed:</span>
                    <span class="font-bold text-gray-900">${item.Value.toLocaleString()}</span>
                </div>
            </div>`;

            dataTable.addRow([
                item.Name,
                item.Value,
                tooltipHtml,
                'color: #198754; stroke-width: 0' // Set cứng màu xanh
            ]);
        });

        var myBarWidth = sortedData.length < 5 ? 50 : '75%';

        var options = {
            fontName: 'Arial', fontSize: 11,
            backgroundColor: 'transparent',
            chartArea: { left: 60, top: 30, right: 20, bottom: 50, width: '100%', height: '70%' },
            vAxis: {
                gridlines: { count: 5, color: '#f3f4f6' },
                minValue: 0,
                format: 'short'
            },
            hAxis: {
                slantedText: true, slantedTextAngle: 45, textStyle: { fontSize: 10 }
            },
            bar: { groupWidth: myBarWidth },
            legend: { position: 'none' },
            tooltip: { isHtml: true }
        };

        var chart = new google.visualization.ColumnChart(document.getElementById(elementId));
        chart.draw(dataTable, options);
    }

    // --- HÀM 2: VẼ BIỂU ĐỒ DEFECT PARETO (GIỮ NGUYÊN LOGIC CŨ ĐANG CHẠY TỐT) ---
    function drawDefectPareto(data) {
        var elementId = 'defect_chart';
        if (!data || data.length === 0) {
             document.getElementById(elementId).innerHTML = '<div class="flex items-center justify-center h-full text-gray-400">No Data</div>';
             return;
        }

        // Chuẩn hóa dữ liệu cho biểu đồ Defect luôn cho chắc
        let chartData = data.map(item => ({
            Name: item.SupplierName || item.supplierName,
            Value: item.SumDefects !== undefined ? item.SumDefects : (item.sumDefects || 0)
        }));

        let sortedData = chartData.sort((a, b) => b.Value - a.Value).filter(x => x.Value > 0);

        if (sortedData.length === 0) {
             document.getElementById(elementId).innerHTML = '<div class="flex items-center justify-center h-full text-gray-400">Data is 0</div>';
             return;
        }
        document.getElementById(elementId).style.width = '100%';

        let totalValue = sortedData.reduce((sum, item) => sum + item.Value, 0);
        let runningTotal = 0;

        var dataTable = new google.visualization.DataTable();
        dataTable.addColumn('string', 'Supplier');
        dataTable.addColumn('number', 'Defects');
        dataTable.addColumn({ type: 'string', role: 'style' });
        dataTable.addColumn({ type: 'number', role: 'annotation' });
        dataTable.addColumn('number', 'Pareto %');
        dataTable.addColumn({ type: 'string', role: 'tooltip' });

        const colorMain = '#198754'; const colorFade = '#d1d5db'; const colorLine = '#064e3b';

        sortedData.forEach(item => {
            let val = item.Value;
            runningTotal += val;
            let cumulativePercent = totalValue === 0 ? 0 : (runningTotal / totalValue);

            // Logic màu Pareto (Xanh đậm / Xám nhạt)
            let barColor = (cumulativePercent <= 0.85) ? colorMain : colorFade;
            if (val < sortedData[0].Value * 0.15) barColor = colorFade;

            let tooltip = `${item.Name}\nDefects: ${val.toLocaleString()}\nPareto: ${(cumulativePercent * 100).toFixed(1)}%`;

            dataTable.addRow([
                item.Name,
                val,
                `color: ${barColor}; stroke-width: 0`,
                val,
                cumulativePercent,
                tooltip
            ]);
        });

        var myBarWidth = sortedData.length < 5 ? 50 : '75%';

        var options = {
            fontName: 'Arial', fontSize: 11, backgroundColor: 'transparent',
            chartArea: { left: 50, top: 30, right: 50, bottom: 50, width: '100%', height: '70%' },
            seriesType: 'bars',
            series: { 1: { type: 'line', targetAxisIndex: 1, color: colorLine, lineWidth: 2, pointSize: 4 } },
            vAxes: {
                0: { gridlines: { count: 5, color: '#f3f4f6' }, minValue: 0 },
                1: { format: '#%', gridlines: { color: 'transparent' }, minValue: 0, maxValue: 1.1 }
            },
            hAxis: { slantedText: true, textStyle: { fontSize: 10 } },
            bar: { groupWidth: myBarWidth },
            legend: { position: 'none' },
            tooltip: { isHtml: true }
        };

        var chart = new google.visualization.ComboChart(document.getElementById(elementId));
        chart.draw(dataTable, options);
    }
</script>
<script>
    lucide.createIcons();
</script>